<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.whalegoods.mapper.DeviceRoadMapper">
  <resultMap id="BaseResultMap" type="com.whalegoods.entity.DeviceRoad">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="device_id_jp" jdbcType="VARCHAR" property="deviceIdJp" />
    <result column="device_id_supp" jdbcType="VARCHAR" property="deviceIdSupp" />
    <result column="ctn" jdbcType="TINYINT" property="ctn" />
    <result column="path_code" jdbcType="TINYINT" property="pathCode" />
    <result column="floor" jdbcType="TINYINT" property="floor" />
    <result column="goods_sku_id" jdbcType="VARCHAR" property="goodsSkuId" />
    <result column="sale_price" jdbcType="DECIMAL" property="salePrice" />
    <result column="capacity" jdbcType="TINYINT" property="capacity" />
    <result column="stock" jdbcType="TINYINT" property="stock" />
    <result column="warning_num" jdbcType="TINYINT" property="warningNum" />
    <result column="warning_switch" jdbcType="TINYINT" property="warningSwitch" />
    <result column="lack_level" jdbcType="TINYINT" property="lackLevel" />
    <result column="monitor_theme_id" jdbcType="VARCHAR" property="monitorThemeId" />
    <result column="create_by" jdbcType="VARCHAR" property="createBy" />
    <result column="create_date" jdbcType="DATE" property="createDate" />
    <result column="update_by" jdbcType="VARCHAR" property="updateBy" />
    <result column="update_date" jdbcType="DATE" property="updateDate" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
  </resultMap>
  
  <resultMap id="BaseResultMap2" type="com.whalegoods.entity.response.ResDeviceGoodsInfo">
    <result column="goods_code" jdbcType="VARCHAR" property="goodsCode" />
    <result column="goods_name" jdbcType="VARCHAR" property="goodsName" />
    <result column="goods_name_en" jdbcType="VARCHAR" property="goodsNameEn" />
    <result column="ctn" jdbcType="TINYINT" property="ctn" />
    <result column="spec" jdbcType="VARCHAR" property="spec" />
    <result column="goods_detail" jdbcType="VARCHAR" property="goodsDetail" />
    <result column="made_in" jdbcType="VARCHAR" property="madeIn" />
    <result column="market_price" jdbcType="DECIMAL" property="marketPrice" />
    <result column="sale_price" jdbcType="DECIMAL" property="salePrice" />
    <result column="path_code" jdbcType="TINYINT" property="pathCode" />
    <result column="floor" jdbcType="TINYINT" property="floor" />
    <result column="pic_url" jdbcType="VARCHAR" property="picUrl" />
    <result column="stock" jdbcType="TINYINT" property="stock" />
    <result column="adsMiddleType" jdbcType="TINYINT" property="saleType" />
  </resultMap>
  
  <sql id="Base_Column_List">
    id, 
    device_id_jp, 
    device_id_supp, 
    tab_code, 
    road_code, 
    level, 
    goods_sku_id, 
    current_price,
    capacity,
    stock,
    warning_num,
    warning_switch,
    lack_level,
    monitor_theme_id,
    create_by, 
    create_date, 
    update_by, 
    update_date, 
    remark
  </sql>
  
   <sql id="Base_Column_List2">
    a.sale_price,
    a.path_code,
    a.floor,
    a.ctn, 
    a.stock,
    b.goods_code, 
    b.goods_name, 
    b.goods_name_en,
    b.spec, 
    b.goods_detail, 
    b.pic_url,
    b.made_in, 
    b.market_price,
    d.type adsMiddleType
  </sql>
  
     <sql id="Base_Column_List3">
    a.sale_price,
    a.path_code,
    a.floor,
    a.ctn, 
    a.stock,
    b.goods_code, 
    b.goods_name, 
    b.goods_name_en,
    b.spec, 
    b.goods_detail, 
    b.pic_url,
    b.made_in, 
    b.market_price
  </sql>
  
 <!--  根据设备编号查询所有商品 -->
    <select id="selectByIdOfJpAndSupp" parameterType="java.util.Map" resultMap="BaseResultMap2">
    SELECT 
    <include refid="Base_Column_List2" />
    FROM device_road a INNER JOIN goods_sku b ON a.goods_sku_id=b.id
    INNER JOIN device c  ON c.id=a.device_id LEFT JOIN goods_ads_middle d ON d.device_road_id=a.id
    WHERE c.device_id_jp=#{deviceIdJp} AND c.device_id_supp=#{deviceIdSupp}
  </select>
  
   <!--  根据当前设备商品编号或货道号获取商品信息 -->
    <select id="selectByCondition" parameterType="java.util.Map" resultMap="BaseResultMap2">
    SELECT 
    <include refid="Base_Column_List3" />
    FROM device_road a INNER JOIN goods_sku b ON a.goods_sku_id=b.id
    INNER JOIN device c  ON c.id=a.device_id 
    <where>
			c.device_id_jp=#{deviceIdJp} AND c.device_id_supp=#{deviceIdSupp}
			<if test="goodsCode !=null and goodsCode !=''">
				AND b.goods_code=#{goodsCode}
			</if>
			<if test="pathCode !=null and pathCode !=''">
				AND a.path_code=#{pathCode}
			</if>
			<if test="floor !=null and floor !=''">
				AND a.floor=#{floor}
			</if>
		    <if test="ctn !=null and ctn !=''">
				AND a.ctn=#{ctn}
			</if>
		 </where>
  </select>


  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from sys_user
    where id = #{id,jdbcType=VARCHAR}
  </select>
  
  	<!-- 根据条件更新货道信息 -->
		<update id="updateDeviceRoad" parameterType="com.whalegoods.entity.DeviceRoad">
		UPDATE device_road a INNER JOIN device b ON a.device_id=b.id
	   <set>
      <if test="stock != null and stock != ''">a.stock=a.stock+#{stock},</if>
      a.update_date=now(),
      </set>
    		<where>
    		<if test="deviceIdJp !=null and deviceIdJp !=''">
				AND b.device_id_jp=#{deviceIdJp}
			</if>
			<if test="deviceIdSupp !=null and deviceIdSupp !=''">
				AND b.device_id_supp=#{deviceIdSupp}
			</if>
		    <if test="pathCode !=null and pathCode !=''">
				AND a.path_code=#{pathCode}
			</if>
			<if test="floor !=null and floor !=''">
				AND a.floor=#{floor}
			</if>
			<if test="ctn !=null and ctn !=''">
				AND a.ctn=#{ctn}
			</if>
		 </where>
	</update>
	
	  	<!-- 根据条件更新货道信息 -->
		<update id="updateStockNoRepeat" parameterType="com.whalegoods.entity.DeviceRoad">
		UPDATE device_road a INNER JOIN device b ON a.device_id=b.id
	   <set>
      <if test="stock != null and stock != ''">a.stock=a.stock+#{stock},</if>
      <if test="stockOrderId != null and stockOrderId != '' and stock!=0">a.stock_order_id=#{stockOrderId},</if>
      a.update_date=now(),
      </set>
    		<where>
    		<if test="deviceIdJp !=null and deviceIdJp !=''">
				AND b.device_id_jp=#{deviceIdJp}
			</if>
			<if test="deviceIdSupp !=null and deviceIdSupp !=''">
				AND b.device_id_supp=#{deviceIdSupp}
			</if>
		    <if test="pathCode !=null and pathCode !=''">
				AND a.path_code=#{pathCode}
			</if>
			<if test="floor !=null and floor !=''">
				AND a.floor=#{floor}
			</if>
			<if test="ctn !=null and ctn !=''">
				AND a.ctn=#{ctn}
			</if>
			<!-- 如果是下单减库存 -->
			<if test="stockOrderId !=null and stockOrderId !='' and stock==-1">
				AND (a.stock_order_id='' OR a.stock_order_id!=#{stockOrderId})
			</if>
			<!-- 如果是退款加库存 -->
			<if test="stockOrderId !=null and stockOrderId !='' and stock==1">
				AND a.stock_order_id=#{stockOrderId}
			</if>
		 </where>
	</update>

</mapper>