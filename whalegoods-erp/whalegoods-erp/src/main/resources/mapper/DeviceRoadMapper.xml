<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.whalegoods.mapper.DeviceRoadMapper">
  <resultMap id="BaseResultMap1" type="com.whalegoods.entity.response.ResDeviceGoodsInfo">
    <result column="goods_code" jdbcType="VARCHAR" property="goodsCode" />
    <result column="goods_name" jdbcType="VARCHAR" property="goodsName" />
    <result column="goods_name_en" jdbcType="VARCHAR" property="goodsNameEn" />
    <result column="ctn" jdbcType="TINYINT" property="ctn" />
    <result column="spec" jdbcType="VARCHAR" property="spec" />
    <result column="goods_detail" jdbcType="VARCHAR" property="goodsDetail" />
    <result column="made_in" jdbcType="VARCHAR" property="madeIn" />
    <result column="market_price" jdbcType="DECIMAL" property="marketPrice" />
    <result column="sale_price" jdbcType="DECIMAL" property="salePrice" />
    <result column="path_code" jdbcType="TINYINT" property="pathCode" />
    <result column="floor" jdbcType="TINYINT" property="floor" />
    <result column="pic_url" jdbcType="VARCHAR" property="picUrl" />
    <result column="stock" jdbcType="TINYINT" property="stock" />
    <result column="adsMiddleType" jdbcType="TINYINT" property="saleType" />
  </resultMap>
  
   <sql id="Base_Column_List1">
    a.sale_price,
    a.path_code,
    a.floor,
    a.ctn, 
    a.stock,
    b.goods_code, 
    b.goods_name, 
    b.goods_name_en,
    b.spec, 
    b.goods_detail, 
    b.pic_url,
    b.made_in, 
    b.market_price,
    d.type adsMiddleType
  </sql>
  
   <sql id="Base_Column_List2">
    a.sale_price,
    a.path_code,
    a.floor,
    a.ctn, 
    a.stock,
    b.goods_code, 
    b.goods_name, 
    b.spec, 
    b.goods_detail, 
    b.pic_url,
    b.made_in, 
    b.market_price
  </sql>
  
  <resultMap id="BaseResultMap2" type="com.whalegoods.entity.DeviceRoad">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="device_id_jp" jdbcType="VARCHAR" property="deviceIdJp" /> 	
    <result column="device_id_supp" jdbcType="VARCHAR" property="deviceIdSupp" />
    <result column="short_name" jdbcType="VARCHAR" property="shortName" />
    <result column="goods_code" jdbcType="VARCHAR" property="goodsCode" />
    <result column="goods_name" jdbcType="VARCHAR" property="goodsName" />
    <result column="ctn" jdbcType="TINYINT" property="ctn" />
    <result column="floor" jdbcType="TINYINT" property="floor" />
    <result column="path_code" jdbcType="TINYINT" property="pathCode" />
    <result column="sale_price" jdbcType="DECIMAL" property="salePrice" />
    <result column="capacity" jdbcType="TINYINT" property="capacity" />
    <result column="stock" jdbcType="TINYINT" property="stock" />
    <result column="warning_num" jdbcType="TINYINT" property="warningNum" />
    <result column="lack_level" jdbcType="TINYINT" property="lackLevel" />
    <result column="lock_status" jdbcType="TINYINT" property="lockStatus" />
  </resultMap>
  
  <sql id="Base_Column_List3">
    c.device_id_jp,
    c.device_id_supp,
    c.short_name,
    b.goods_code,
    b.goods_name,
    a.id,
    a.ctn,
    a.floor,
    a.path_code,
    a.sale_price,
    a.capacity,
    a,stock,
    a.warning_num,
    a.lack_level,
    c.lock_status,
  </sql>
  
      <select id="selectById" parameterType="com.whalegoods.entity.DeviceRoad" resultMap="BaseResultMap2">
    SELECT <include refid="Base_Column_List3" />
    FROM device_road a 
    INNER JOIN goods_sku b ON a.goods_sku_id=b.id
    INNER JOIN device c  ON c.id=a.device_id 
    WHERE a.id=#{id}
  </select>
  
    <select id="selectListByObjCdt" parameterType="com.whalegoods.entity.DeviceRoad" resultMap="BaseResultMap2">
    SELECT <include refid="Base_Column_List3" />
    FROM device_road a 
    INNER JOIN goods_sku b ON a.goods_sku_id=b.id
    INNER JOIN device c  ON c.id=a.device_id 
   <where>
     <if test="deviceIdJp !=null and deviceIdJp !=''"> 
     AND c.device_id_jp=#{deviceIdJp}
     </if>
     <if test="deviceIdSupp !=null and deviceIdSupp !=''"> 
     AND c.device_id_supp=#{deviceIdSupp}
     </if>
     <if test="shortName !=null and shortName !=''"> 
     AND c.short_name LIKE  "%" #{shortName} "%"
     </if>
    </where>
  </select>
  
 <!--  根据设备编号查询所有商品，给柜机API使用 -->
    <select id="selectByIdOfJpAndSupp" parameterType="java.util.Map" resultMap="BaseResultMap1">
    SELECT <include refid="Base_Column_List1" />
    FROM device_road a 
    INNER JOIN goods_sku b ON a.goods_sku_id=b.id
    INNER JOIN device c  ON c.id=a.device_id 
    LEFT JOIN goods_ads_middle d ON d.device_road_id=a.id
    WHERE c.device_id_jp=#{deviceIdJp} AND c.device_id_supp=#{deviceIdSupp}
  </select>
  
   <!--  根据当前设备商品编号或货道号获取商品信息 -->
    <select id="selectByGoodsOrPathCode" parameterType="java.util.Map" resultMap="BaseResultMap1">
    SELECT  <include refid="Base_Column_List2" />
    FROM device_road a INNER JOIN goods_sku b ON a.goods_sku_id=b.id
    INNER JOIN device c  ON c.id=a.device_id 
    <where>
			c.device_id_jp=#{deviceIdJp} AND c.device_id_supp=#{deviceIdSupp}
			<if test="goodsCode !=null and goodsCode !=''">
				AND b.goods_code=#{goodsCode}
			</if>
			<if test="pathCode !=null and pathCode !=''">
				AND a.path_code=#{pathCode}
			</if>
			<if test="floor !=null and floor !=''">
				AND a.floor=#{floor}
			</if>
		    <if test="ctn !=null and ctn !=''">
				AND a.ctn=#{ctn}
			</if>
		 </where>
  </select>
	
	  	<!-- 根据条件更新货道信息 -->
		<update id="updateByObjCdt" parameterType="com.whalegoods.entity.DeviceRoad">
		UPDATE device_road a INNER JOIN device b ON a.device_id=b.id
	   <set>
      <if test="stock != null and stock != ''">a.stock=a.stock+#{stock},</if>
      <if test="stockOrderId != null and stockOrderId != '' and stock!=0">a.stock_order_id=#{stockOrderId},</if>
      a.update_date=now(),
      </set>
    		<where>
    		<if test="deviceIdJp !=null and deviceIdJp !=''">
				AND b.device_id_jp=#{deviceIdJp}
			</if>
			<if test="deviceIdSupp !=null and deviceIdSupp !=''">
				AND b.device_id_supp=#{deviceIdSupp}
			</if>
		    <if test="pathCode !=null and pathCode !=''">
				AND a.path_code=#{pathCode}
			</if>
			<if test="floor !=null and floor !=''">
				AND a.floor=#{floor}
			</if>
			<if test="ctn !=null and ctn !=''">
				AND a.ctn=#{ctn}
			</if>
			<!-- 如果是下单减库存 -->
			<if test="stockOrderId !=null and stockOrderId !='' and stock==-1">
				AND (a.stock_order_id='' OR a.stock_order_id!=#{stockOrderId})
			</if>
			<!-- 如果是退款加库存 -->
			<if test="stockOrderId !=null and stockOrderId !='' and stock==1">
				AND a.stock_order_id=#{stockOrderId}
			</if>
		 </where>
	</update>
	
	<select id="selectCountByMapCdt" parameterType="java.util.Map" resultType="java.lang.Integer">
    SELECT COUNT(1) FROM device_road c
   <where>
     <if test="deviceIdJp !=null and deviceIdJp !=''"> 
     AND c.device_id_jp=#{deviceIdJp}
     </if>
     <if test="ctn !=null and ctn !=''"> 
     AND c.ctn=#{ctn}
     </if>
     <if test="floor !=null and floor !=''"> 
     AND c.floor = #{floor} 
     </if>
     <if test="pathCode !=null and pathCode !=''"> 
     AND c.path_code = #{pathCode} 
     </if>
    </where>
  </select>

</mapper>