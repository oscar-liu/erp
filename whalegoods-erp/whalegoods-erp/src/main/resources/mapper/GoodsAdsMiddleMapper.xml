<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whalegoods.mapper.GoodsAdsMiddleMapper">
  <resultMap id="BaseResultMap" type="com.whalegoods.entity.GoodsAdsMiddle">
  <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="goods_code" jdbcType="VARCHAR" property="goodsCode" />
    <result column="start_date" jdbcType="TIMESTAMP" property="startDate" />
    <result column="end_date" jdbcType="TIMESTAMP" property="endDate" />
    <result column="start_hms" jdbcType="VARCHAR" property="startHms" />
    <result column="end_hms" jdbcType="VARCHAR" property="endHms" />
    <result column="type" jdbcType="TINYINT" property="type" />
    <result column="device_id" jdbcType="VARCHAR" property="deviceId" />
    <result column="market_price" jdbcType="DECIMAL" property="marketPrice" />
    <result column="pic_url" jdbcType="VARCHAR" property="picUrl" />
    <result column="goods_name" jdbcType="VARCHAR" property="goodsName" />
    <result column="sale_price" jdbcType="DECIMAL" property="salePrice" />
    <result column="stock" jdbcType="INTEGER" property="stock" />
    <result column="short_name" jdbcType="VARCHAR" property="shortName" />
  </resultMap>
  
  <sql id="Base_Column_List">
    a.id,
    a.goods_code,
    a.start_date,
    a.end_date,
    a.start_hms,
    a.end_hms,
    a.type,
    a.device_id,
    b.market_price,
    b.pic_url,
    b.goods_name,
    c.sale_price,
    SUM(c.stock) stock,
    d.short_name
  </sql>
  
   <select id="selectById" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" /> FROM goods_ads_middle a 
    INNER JOIN  goods_sku b ON b.goods_code=a.goods_code
    INNER JOIN device_road c ON c.goods_sku_id=b.id
    INNER JOIN device d ON  d.id=a.device_id
    WHERE a.id= #{_parameter}
  </select>
  
    <!-- 查询促销商品列表(柜机API)-->
    <select id="selectAdsMiddleList" parameterType="com.whalegoods.entity.request.ReqGetAdsMiddleList" resultMap="BaseResultMap">
    SELECT  <include refid="Base_Column_List" />  FROM goods_ads_middle a 
  INNER JOIN goods_sku b 
    ON b.goods_code = a.goods_code 
  INNER JOIN device d  ON d.id = a.device_id 
  INNER JOIN device_road c ON c.device_id=a.device_id AND c.goods_sku_id=b.id
    <where>
     <if test="device_code_wg !=null and device_code_wg !=''"> AND d.device_id_jp=#{device_code_wg}</if>
     <if test="device_code_sup !=null and device_code_sup !=''"> AND d.device_id_supp=#{device_code_sup}</if>
    </where>
      GROUP BY  a.goods_code
  </select>
  
      <!-- 查询促销商品列表(ERP)-->
    <select id="selectListByObjCdt" parameterType="com.whalegoods.entity.GoodsAdsMiddle" resultMap="BaseResultMap">
    SELECT  <include refid="Base_Column_List" />  FROM goods_ads_middle a 
    INNER JOIN  goods_sku b ON b.goods_code=a.goods_code
    INNER JOIN device d ON  d.id=a.device_id
    LEFT JOIN device_road c ON c.goods_sku_id=b.id
    <where>
     <if test="deviceId !=null and deviceId !=''"> AND d.id=#{deviceId}</if>
    </where>
    GROUP BY a.goods_code,a.device_id
  </select>
  
  <!-- 插入新记录 -->
    <insert id="insert" parameterType="com.whalegoods.entity.GoodsAdsMiddle">
    INSERT INTO goods_ads_middle (
    id,
    goods_code, 
    start_date, 
    end_date,
    start_hms,
    end_hms,
    type,
    device_id,
    create_by,
    create_date,
    update_by,
    update_date)
    VALUES (
    #{id},
    #{goodsCode}, 
    #{startDate}, 
    #{endDate},
    #{startHms},
    #{endHms},
    #{type},
    #{deviceId},
    #{createBy}, 
    now(),
    #{updateBy},
    now()
    )
  </insert>
  
  	<update id="updateByObjCdt" parameterType="com.whalegoods.entity.GoodsAdsMiddle">
		UPDATE goods_ads_middle a 
	   <set>
      <if test="goodsCode != null and goodsCode != ''">a.goods_code=#{goodsCode},</if>
      a.start_date=#{startDate},
      a.end_date=#{endDate},
      a.start_hms=#{startHms},
      a.end_hms=#{endHms},
      <if test="type != null and type!='' ">a.type=#{type},</if>
      <if test="deviceId != null and deviceId != ''">a.device_id=#{deviceId},</if>
      <if test="updateBy != null and updateBy != '' ">a.update_by = #{updateBy}, </if>
      update_date = now(),
      </set>
        <where>
        <if test="id !=null and id !=''"> AND a.id =#{id}</if>
    </where>
	</update>
	
	 <select id="selectCountByMapCdt" parameterType="java.util.Map" resultType="java.lang.Integer">
    SELECT COUNT(id) FROM goods_ads_middle
    <where>
     <if test="deviceId !=null and deviceId !=''"> AND device_id=#{deviceId}</if>
     <if test="goodsCode !=null and goodsCode !=''"> AND goods_code=#{goodsCode}</if>
    </where>
  </select>
  
     <delete id="deleteById" parameterType="java.lang.String">
    DELETE FROM goods_ads_middle  WHERE id = #{_parameter}
  </delete>

</mapper>